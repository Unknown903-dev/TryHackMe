Nmap Live host Directory

Nmap = want to target network, discover the system that are online before port scanning 

this stage is crucial, port scanning offline systems will only wast time andn create unnecessary noise on the network

- ARP scan: This scan uses ARP requests to discover live hosts
- ICMP scan: This scan uses ICMP requests to identify live hosts
- TCP/UDP ping scan: This scan sends packets to TCP ports and UDP ports to determine live hosts.

Nmap scan steps 
- enumerate targets
- discover live hosts
- reverse DNS lookup
- scan ports
- detect versions detect os 
- trace route
- scripts 
- write output

we will focus on first 3
-----------------------------------------
- network segment = a group of computers connected using a shared medium
  medium can be the Ethernet switch or WiFi access point.
- IP network, a subnetwork is usually the equivalent of one or more network segments connected together and configured to use the same router
-  network segment refers to a physical connection, while a subnetwork refers to a logical connection.

- subnetwork, or simply a subnet, has its own IP address range and is connected to a more extensive network via a router.
 could have firewall depending on security
- Subnets with /16, which means that the subnet mask can be written as 255.255.0.0. This subnet can have around 65 thousand hosts.
Subnets with /24, which indicates that the subnet mask can be expressed as 255.255.255.0. This subnet can have around 250 hosts.

- want to discover more info on group of hosts or about subnet
- if connected to same subnet, can expect your scanner to rely on arp queries to discover live hosts
- arp query aims to get the hardware address (mac address), so communication over link layer is possible
- can use to see if hosts is onlone

overall, when using arp request to recieve the mac address the device needs to be in the same subnet, if not the request wont go through
-----------------------------------------------------------
differ techniques can use to scan

------ first need to specify the target
- list: MACHINE_IP scanme.nmap.org example.com will scan 3 IP addresses.
- range: 10.11.12.15-20 will scan 6 IP addresses: 10.11.12.15, 10.11.12.16,… and 10.11.12.20.
- subnet: MACHINE_IP/30 will scan 4 IP addresses.
- can also provide a file as input for your list of targets, nmap -iL list_of_hosts.txt.
###############################
- If you want to check the list of hosts that Nmap will scan, you can use
  nmap -sL TARGETS
################################
  will give you a detailed list of the hosts that Nmap will scan without scanning them; however, 
  Nmap will attempt a reverse-DNS resolution on all the targets to obtain their names
- if dont want nmapp to the dns server you can add -n 
---------------------------------------------------------
can discover the live hosts
- ARP from Link Layer
- ICMP from Network Layer
- TCP from Transport Layer
- UDP from Transport Layer

https://tryhackme-images.s3.amazonaws.com/user-uploads/5f04259cf9bf5b57aed2c476/room-content/745e0412b319d324352c7b29863b74f4.png

- ARP has one purpose: sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.
- ICMP has many types. ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply).
- a scanner can send a crafted packet to common TCP / UDP ports to check if the target responds
  effecient even when icmp echo is blocked


when sending ping = arp request then arp response then ping 
- how to know which hosts are up and running 
- When a privileged user tries to scan targets on a local network (Ethernet), Nmap uses ARP requests. A privileged user is root or a user who belongs to sudoers and can run sudo.
- When a privileged user tries to scan targets outside the local network, Nmap uses ICMP echo requests, TCP ACK (Acknowledge) to port 80, TCP SYN (Synchronize) to port 443, and ICMP timestamp request.
- When an unprivileged user tries to scan targets outside the local network, Nmap resorts to a TCP 3-way handshake by sending SYN packets to ports 80 and 443.

- Nmap, by default, uses a ping scan to find live hosts, then proceeds to scan live hosts only.
- If you want to use Nmap to discover online hosts without port-scanning the live systems, you can issue 
################
nmap -sn TARGETS  = discover online hosts without port scan
################

- arp scan is possibe if on the same subnet as target system

- link layer header = contain the source MAC address and destination MAC address etc..
  need to know mac of any system before you can communicate
- os sends arp query = gets mac address
- arp query only WORKS IF the target is on the same subnet as yourself = on same ethernet / wifi
#########################
nmap -PR -sn Target = arp scan without port scan   -PR = only arp scan
########################

Nmap sends ARP requests to all the target computers, and those online should send an ARP reply back.
- comp1 send arp request to comp2
- comp2 arp reply to comp1
- case: host is live

--------------------------------------------------
arp scan :     apt install arp-scan

- arp-scan; it provides many options to customize your scan. Visit the arp-scan wiki for detailed information
-  arp-scan --localnet or simply arp-scan -l = This command will send ARP queries to all valid IP addresses on your local networks
- if your system has more than one interface and you are interested in discovering the live hosts on one of them, you can specify the interface using -I
  sudo arp-scan -I eth0 -l will send ARP queries for all valid IP addresses on the eth0 interface.
- arp-scan and nmap -PR -sn yield similar traffic patterns
 can analyze this in wireshark or tcpdump

----------------------------------------------------
- pinging every ip is not reliable many firewalls block icmp echo  
- new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default
- an ARP query will precede the ICMP request if your target is on the same subnet.
- To use ICMP echo request to discover live hosts, add the option -PE. (Remember to add -sn if you don’t want to follow that with a port scan
- ICMP echo scan works by sending an ICMP echo request and expects the target to reply with an ICMP echo reply if it is online.
#############3
nmap -PE -sn Target
- comp1 send icmp echo request to comp2
-  comp2 send icmp echo reply to comp1
- case: host live

it sends icmp echo packets to every ip adddress on the subnet, we live host to reply 

- don’t expect to learn the MAC addresses of the targets unless they are on the same subnet as our system
-  on wireshark = can see that we have one source IP address on a different subnet than that of the destination subnet, sending ICMP echo requests to all the IP addresses in the target subnet to see which one will reply.
--------------------------------------
- ICMP echo requests tend to be blocked =  you might also consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online
- nmap uses timestamp request icmp type 13 and checks whether it will get a Timestamp reply (ICMP Type 14)
- -PP = icmp timestamp request
nmap -PP -sn Target
- comp1 icmp timestamp request to comp2
- comp2 icmp timestamp reply tp comp1 
- case: host is live

- this scan will send many ICMP timestamp requests to every valid IP address in the target subnet
- wireshark = can see one source IP address sending ICMP packets to every possible IP address to discover online hosts.
-------------------------------------
- Nmap uses address mask queries (ICMP Type 17) and checks whether it gets an address mask reply (ICMP Type 18)
- This scan can be enabled with the option -PM
- Nmap -PM -sn Target
- comp1 icmp address mask request comp2
- comp2 icmp address mask reply comp1 
- case: host is live

when ran no host appeared due to firewall on the route is blocking this type of icmp packet
- so if one is blocked we can use the others

-pp = icmp time stamp
-pm = icmp address mask 
-pe = icmp echo 
---------------------------------------------------------------
TCP SYN ping

- can send a packet with the SYN (Synchronize) flag set to a TCP port, 80 by default, and wait for a response
- An open port should reply with a SYN/ACK (Acknowledge); a closed port would result in an RST (Reset).
- we only check whether we will get any response to infer whether the host is up

TCP 3 way handshake
- comp1 SYN to comp2
- comp2 SYN/ACK to comp1
- comp1 ACK to comp2
case: tCP port is open

If you want Nmap to use TCP SYN ping, you can do so via the option -PS followed by the port number, range, list, or a combination
- EX: -PS21 = target port 21   -PS21-25 target 21,22,23,24,25
  -PS80,443,8080 = target the 3 ports

priviledge users = root / sudo dont need to complete TCP 3 way even if port is open 
unpriviledge = do need 3 way

###############################
nmap -PS -sn Target

- comp1 SYN to comp2
- somp2 syn/ack comp1
- comp1 RST comp2
CASE: TCP port is open

- if we dont specify port on -PS = TCP ping scan, nmap use common ports like port 80 anything listening on 80 is expected to reply
from example given
- we discover many packets with the ACK flag set and sent to port 80 of the target
- nmap sends each packet twice 
------------------------------------------------------
UDP ping

similar to TCP SYN ping, sending a UDP packet to a closed UDP port = expect an icmp port unreachable packet
##################
nmap -PU -sn Target		| - comp1 udp packet to comp2
- comp1 udp packet to comp2	| - comp2 to icmp type3 code 3 comp1
case: udp port is open		|case: udp port is closed. this leads to icmp destination unreachable(port unreachable)
###########################################3
- wireshark  = notice Nmap sending UDP packets to UDP ports that are most likely closed. also shows that Nmap uses an uncommon UDP port to trigger an ICMP destination unreachable (port unreachable) error.
--------------------------------------------------------------
masscan 

- masscan similar to udp ping when discovering available systems 
- finish network scan fast = masscan is aggressive with rate of packets generated 
 -p can be followed by a port number, list, or range. Consider the following examples:

masscan MACHINE_IP/24 -p443
masscan MACHINE_IP/24 -p80,443
masscan MACHINE_IP/24 -p22-25
masscan MACHINE_IP/24 ‐‐top-ports 100

apt install masscan.
---------------------------------------------------------------

- nmap default behaviour = use reverse DNS online hosts 
- gettin host name can help reveal alot, 
  but if dont want the DNS query we can use # -n  #
- can use -R to query the DNS server even for offline hosts
- specific dns server can add 
 ######################
--dns-servers DNS_SERVER
########################
-------------------------------------------------------------------
Scan Type		Example Command

ARP Scan		sudo nmap -PR -sn MACHINE_IP/24
ICMP Echo Scan		sudo nmap -PE -sn MACHINE_IP/24
ICMP Timestamp Scan	sudo nmap -PP -sn MACHINE_IP/24
ICMP Address Mask Scan	sudo nmap -PM -sn MACHINE_IP/24
TCP SYN Ping Scan	sudo nmap -PS22,80,443 -sn MACHINE_IP/30
TCP ACK Ping Scan	sudo nmap -PA22,80,443 -sn MACHINE_IP/30
UDP Ping Scan		sudo nmap -PU53,161,162 -sn MACHINE_IP/30
-----------------------------------------------------------------------
Remember to add -sn if you are only interested in host discovery without port-scanning. Omitting -sn will let Nmap default to port-scanning the live hosts.

Option	Purpose
-n	no DNS lookup
-R	reverse-DNS lookup for all hosts
-sn	host discovery only
-------------------------------------------------------------------------



-n










